<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevLadder - ICT Ranking System</title>
    <title>DevLadder - ICT Ranking System</title>
    <!-- ======== SEO Meta Tags - START ======== -->
    <meta name="description" content="DevLadder is the official student ranking and performance tracking system for Bhanuka Ekanayaka sir's ICT classes. Check your exam rank, track progress, and climb the ladder of success.">
    <meta name="keywords" content="DevLadder, ICT Ranking, Bhanuka Ekanayaka, Student Ranking Sri Lanka, Exam Results, Performance Tracker, ICT Class">
    <meta name="author" content="Bhanuka Ekanayaka ICT">
    <meta name="google-site-verification" content="AMzpdwUG8b13d5MEQWkkbxDZ9zBZfGFWQl7jZabN8fQ" />
    <!-- ======== SEO Meta Tags - END ======== -->
    <!-- Google Fonts: Inter & Noto Sans Sinhala for the quote -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+Sinhala:wght@700&display=swap" rel="stylesheet">
    <!-- Icon Library: Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --dark-bg: #1a1a2e; --dark-card: #16213e; --accent-blue: #0f3460; --light-text: #e9ecef;
            --dim-text: #adb5bd; --highlight-color: #5372f0; --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
            --success: #28a745; --danger: #dc3545;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark-bg); color: var(--light-text); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px; }
        .container { width: 100%; max-width: 1200px; margin: auto; position: relative; }
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dark-bg); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 20px; transition: opacity 0.5s ease-out; }
        .ladder-loader-text { font-size: 1.5rem; font-weight: 600; color: var(--highlight-color); }
        .ladder { width: 60px; height: 150px; border-left: 5px solid var(--light-text); border-right: 5px solid var(--light-text); position: relative; }
        .ladder .step { width: 100%; height: 5px; background: var(--light-text); position: absolute; left: 0; animation: climb 2s infinite linear; }
        .ladder .step:nth-child(1) { top: 0; animation-delay: 0s; } .ladder .step:nth-child(2) { top: 30px; animation-delay: 0.2s; }
        .ladder .step:nth-child(3) { top: 60px; animation-delay: 0.4s; } .ladder .step:nth-child(4) { top: 90px; animation-delay: 0.6s; } .ladder .step:nth-child(5) { top: 120px; animation-delay: 0.8s; }
        @keyframes climb { 0% { transform: translateY(0); opacity: 1; } 50% { opacity: 1; } 100% { transform: translateY(150px); opacity: 0; } }
        .page { display: none; } .page.active { display: block; }
        .card { background-color: var(--dark-card); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--accent-blue); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 8px; background-color: var(--highlight-color); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn:hover { background-color: #4361ee; transform: translateY(-2px); }
        .btn:disabled { background-color: #2b3a69; cursor: not-allowed; transform: translateY(0); }
        .btn i { font-size: 1.2rem; }
        .btn.secondary { background-color: transparent; border: 1px solid var(--accent-blue); color: var(--light-text); }
        .btn.secondary:hover { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .header .header-left { display: flex; align-items: center; gap: 15px; }
        .header-profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--highlight-color); }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-blue); background-color: var(--dark-bg); color: var(--light-text); font-size: 1rem; }
        .status-message { margin-top: 15px; font-weight: 500; min-height: 20px;} .status-message.success { color: var(--success); } .status-message.error { color: var(--danger); }
        
        /* === LOGIN PAGE STYLES (RESTORED & CLEANED) === */
        #login-page .login-wrapper { max-width: 800px; margin: 0 auto; }
        #login-page .login-container { background-color: var(--dark-card); padding: 40px; border-radius: 12px; text-align: center; max-width: 400px; margin: 40px auto; border: 1px solid var(--accent-blue); }
        #login-page .login-container h1 { font-size: 2.5rem; color: var(--highlight-color); margin-bottom: 10px; }
        #login-page .login-container p.tagline { color: var(--dim-text); margin-bottom: 30px; }
        .instructor-card { display: flex; align-items: center; gap: 25px; padding: 20px; background-color: var(--accent-blue); border-radius: 12px; max-width: 600px; margin: 40px auto; }
        .instructor-image { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--highlight-color); flex-shrink: 0; }
        .instructor-details h3 { font-size: 1.5rem; color: var(--light-text); font-weight: 700; }
        .instructor-details .sinhala-quote { font-family: 'Noto Sans Sinhala', sans-serif; font-size: 1.4rem; color: var(--highlight-color); margin-bottom: 10px; font-weight: 700; }
        .leaderboard-section { margin-top: 40px; }
        .leaderboard-section h2 { margin-bottom: 20px; text-align: center; font-size: 1.8rem; }
        .leaderboard-table { width: 100%; border-collapse: collapse; background-color: var(--dark-card); border-radius: 12px; overflow: hidden; }
        .leaderboard-table th, .leaderboard-table td { padding: 15px 20px; text-align: left; vertical-align: middle; }
        .leaderboard-table .rank { font-weight: 700; font-size: 1.2rem; width: 60px; }
        .leaderboard-table .leaderboard-student { display: flex; align-items: center; gap: 15px; }
        .leaderboard-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .leaderboard-pic.default-pic { background-color: var(--accent-blue); display: flex; align-items: center; justify-content: center; color: var(--light-text); }
        
        /* === POPUP STYLES === */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .popup-overlay.active { display: flex; opacity: 1; }
        .popup-content { background-color: var(--dark-card); padding: 30px; border-radius: 12px; text-align: center; max-width: 450px; width: 90%; border: 1px solid var(--accent-blue); transform: scale(0.9); transition: transform 0.3s ease; }
        .popup-overlay.active .popup-content { transform: scale(1); }
        .popup-content h2 { font-size: 2rem; color: var(--highlight-color); margin-bottom: 15px; }
        .popup-content p { color: var(--dim-text); margin-bottom: 25px; line-height: 1.6; }
        .popup-close { position: absolute; top: 15px; right: 15px; font-size: 2rem; color: var(--dim-text); cursor: pointer; }

        /* === STUDENT DASHBOARD LAYOUT (RESTORED) === */
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media (min-width: 992px) { .dashboard-grid { grid-template-columns: 2fr 1fr; } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top:20px; }
        .stat-card { background-color: var(--accent-blue); padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card h3 { font-size: 1rem; color: var(--dim-text); margin-bottom: 10px; }
        .stat-card p { font-size: 2.2rem; font-weight: 700; }
        .chart-container { height: 400px; }
        
        @media (max-width: 600px) {
            .instructor-card { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="preloader"><div class="ladder"><div class="step"></div><div class="step"></div><div class="step"></div><div class="step"></div><div class="step"></div></div><div class="ladder-loader-text">Loading DevLadder...</div></div>
    
    <div class="container">
        <div id="login-page" class="page">
             <div class="login-wrapper">
                <div class="login-container">
                    <h1>DevLadder</h1>
                    <p class="tagline">Track Your ICT Progress & Climb the Leaderboard</p>
                    <form id="login-form">
                        <div class="input-group"><label for="student-id">Student/Instructor ID</label><input type="text" id="student-id" required></div>
                        <div class="input-group"><label for="password">Password</label><input type="password" id="password" required></div>
                        <button type="submit" class="btn">Login</button>
                        <p id="login-error" class="status-message"></p>
                    </form>
                </div>
                <!-- Instructor Card Added Cleanly -->
                <section class="instructor-card">
                    <img src="sir-photo.jpg" alt="Instructor Photo" class="instructor-image">
                    <div class="instructor-details">
                        <p class="sinhala-quote">'‡∂Ü‡∂Ø‡∂ª‡∂´‡∑ì‡∂∫ ‡∂ú‡∑î‡∂ª‡∑î ‡∂¥‡∑û‡∂ª‡∑î‡∑Ç‡∂∫'</p>
                        <h3>Bhanuka Ekanayaka</h3>
                    </div>
                </section>
                <section class="leaderboard-section">
                    <h2>üèÜ Latest Leaderboard <span id="latest-paper-title-leaderboard"></span></h2>
                    <table class="leaderboard-table">
                        <thead id="leaderboard-head"></thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </section>
             </div>
        </div>

        <div id="student-dashboard" class="page">
            <header class="header"><div class="header-left"><img id="header-profile-pic" src="https://placehold.co/100x100/16213e/e9ecef?text=Me" alt="Profile" class="header-profile-pic"><div><p style="font-size: 1.8rem; margin-bottom: 5px;">Welcome, <span id="student-name" style="font-weight: 700; color: var(--highlight-color);"></span>!</p><small style="color:var(--dim-text)">Your personal progress hub</small></div></div><div class="header-controls"><button id="my-profile-btn" class="btn secondary"><i class="ph-bold ph-user-circle"></i> My Profile</button><button class="logout-btn btn"><i class="ph-bold ph-sign-out"></i> Logout</button></div></header>
            <main><div class="dashboard-grid"><div class="left-column"><div class="card"><h2>Latest Paper Results: <span id="latest-paper-title-student"></span></h2><div class="stats-grid"><div class="stat-card"><h3>Your Rank</h3><p id="student-rank">--/--</p></div><div class="stat-card"><h3>Your Score</h3><p id="student-score">--%</p></div><div class="stat-card"><h3>Class Average</h3><p id="class-average-score">--%</p></div></div></div><div class="card"><h2>Your Performance Progress</h2><div class="chart-container"><canvas id="progress-chart"></canvas></div></div><div class="card"><h2>Detailed History</h2><table class="leaderboard-table"><thead><tr><th>Paper Name</th><th>Your Score</th><th>Your Rank</th><th>Class Average</th></tr></thead><tbody id="history-table-body"></tbody></table></div></div><div class="right-column"><div id="recommendation-container" class="card" style="display:none;"><h3>üí° Personalized Recommendation</h3><p id="recommendation-text"></p><a id="recommendation-link" href="#" target="_blank" rel="noopener noreferrer">Watch Recommended Video ‚ûî</a></div><div class="card"><h3>üì¢ Latest Announcement</h3><div id="announcement-display" class="announcement-card"><p>No announcements yet.</p></div></div><div class="card"><h3>üèÜ My Badges (Coming Soon)</h3><p style="color:var(--dim-text)">You will see your achievements here!</p></div></div></div></main>
        </div>
        
        <div id="instructor-panel" class="page">
            <header class="header"><h1>Instructor Panel</h1><button class="logout-btn btn"><i class="ph-bold ph-sign-out"></i> Logout</button></header>
            <main><div class="instructor-grid" style="grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));"><div class="card"><h2>Upload New Paper Results</h2><form id="upload-form"><div class="input-group"><label for="paper-name">Paper Name</label><input type="text" id="paper-name" placeholder="e.g., Paper No. 03" required></div><div class="input-group"><label for="results-file">Upload Results (CSV File)</label><input type="file" id="results-file" accept=".csv" required><p style="font-size: 0.8rem; color: var(--dim-text); margin-top: 5px;">Format: student_id,score (no header)</p></div><button type="submit" class="btn">Upload Results</button><p id="upload-status" class="status-message"></p></form></div><div class="card"><h2>Manage Recommendations</h2><form id="recommendation-form"><div class="input-group"><label for="rec-paper-name">Paper Name</label><select id="rec-paper-name" required></select></div><div class="input-group" style="display:flex; gap:10px;"><div style="flex:1;"><label for="min-score">Min Score</label><input type="number" id="min-score" min="0" max="100" required></div><div style="flex:1;"><label for="max-score">Max Score</label><input type="number" id="max-score" min="0" max="100" required></div></div><div class="input-group"><label for="rec-text">Recommendation Text</label><textarea id="rec-text" required></textarea></div><div class="input-group"><label for="rec-link">YouTube Video Link</label><input type="url" id="rec-link" placeholder="https://youtube.com/..."></div><button type="submit" class="btn">Add Recommendation</button><p id="rec-status" class="status-message"></p></form></div></div><div class="instructor-grid" style="grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));"><div class="card"><h2>Post an Announcement</h2><form id="announcement-form"><div class="input-group"><label for="ann-title">Title</label><input type="text" id="ann-title" required></div><div class="input-group"><label for="ann-content">Content</label><textarea id="ann-content" required></textarea></div><button type="submit" class="btn">Post Announcement</button><p id="ann-status" class="status-message"></p></form></div><div class="card"><h2>Class Performance Overview</h2><p>Score Distribution for the Latest Paper:</p><div class="chart-container" style="height:250px"><canvas id="distribution-chart"></canvas></div></div></div><div class="instructor-grid" style="grid-template-columns: 1fr;"><div class="card"><h2>Manage Students</h2><div style="display: flex; gap: 25px; flex-wrap: wrap;"><div style="flex: 1; min-width: 300px;"><form id="add-student-form"><h3>Add New Student</h3><div class="input-group"><label for="new-student-id">Student ID</label><input type="text" id="new-student-id" placeholder="e.g., S1001" required></div><div class="input-group"><label for="new-student-name">Full Name</label><input type="text" id="new-student-name" placeholder="e.g., Kamal Perera" required></div><div class="input-group"><label for="new-student-password">Initial Password</label><input type="text" id="new-student-password" required></div><button type="submit" class="btn">Create Student Account</button><p id="add-student-status" class="status-message"></p></form></div><div style="flex: 2; min-width: 400px;"><h3>Existing Students</h3><div style="max-height: 350px; overflow-y: auto;"><table class="leaderboard-table"><thead><tr><th>Student ID</th><th>Name</th></tr></thead><tbody id="student-list-body"></tbody></table></div></div></div></div></div></main>
        </div>
        <div id="profile-page" class="page">
            <header class="header"><h1>My Profile</h1><div class="header-controls"><button id="back-to-dash-btn" class="btn secondary"><i class="ph-bold ph-arrow-left"></i> Back to Dashboard</button></div></header>
            <main><div class="card"><div class="profile-layout" style="display: flex; align-items: flex-start; gap:25px;"><div class="profile-pic-container" style="text-align:center;"><img id="profile-pic-preview" src="https://placehold.co/150x150/16213e/e9ecef?text=Me" alt="Profile Preview" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent-blue); margin-bottom: 15px;"><p id="file-name-display" style="color:var(--dim-text); font-size: 0.9rem; margin-top:10px;">No file chosen</p></div><div style="flex-grow:1;"><form id="profile-form"><h2>Edit Your Profile</h2><div class="input-group"><label>Profile Picture</label><label for="profile-pic-file" class="btn secondary">Choose Image</label><input type="file" id="profile-pic-file" accept="image/png, image/jpeg" style="display:none;"></div><div class="input-group"><label for="profile-bio">Your Bio</label><textarea id="profile-bio" placeholder="Tell us a bit about yourself..." style="min-height: 80px;"></textarea></div><button type="submit" class="btn" id="save-profile-btn"><i class="ph-bold ph-floppy-disk"></i> Save Changes</button><p id="profile-status" class="status-message"></p></form></div></div></div></main>
        </div>
    </div>
    
    <div id="welcome-popup" class="popup-overlay">
        <div class="popup-content"><span class="popup-close">&times;</span><h2>Welcome to DevLadder!</h2><p>Your journey to the top of the leaderboard begins now. Log in to check your progress and climb the ladder to success.</p><button id="close-popup-btn" class="btn">Let's Go!</button></div>
    </div>

    <script>
        // THIS IS THE FULL, CORRECT AND COMPLETE JAVASCRIPT
        const SUPABASE_URL = 'https://etdnqmutegfquovxkznz.supabase.co'; // PASTE YOUR URL HERE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0ZG5xbXV0ZWdmcXVvdnhrem56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNjMyODIsImV4cCI6MjA3MjgzOTI4Mn0.Rr7rZQku5ef6GwyKQagb8Kgpe49GTOThcAHICUFReGw'; // PASTE YOUR KEY HERE
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        document.addEventListener('DOMContentLoaded', () => {
            const pages = document.querySelectorAll('.page');
            const preloader = document.getElementById('preloader');
            const logoutButtons = document.querySelectorAll('.logout-btn');
            const welcomePopup = document.getElementById('welcome-popup');
            const closePopupBtn = document.getElementById('close-popup-btn');
            const popupCloseIcon = document.querySelector('.popup-close');

            let progressChartInstance = null;
            let distributionChartInstance = null;
            let processedImageFile = null;
            const defaultProfilePic = 'https://placehold.co/100x100/16213e/e9ecef?text=Me';

            function showPage(pageId) {
                pages.forEach(page => page.classList.remove('active'));
                const pageToShow = document.getElementById(pageId);
                if(pageToShow) pageToShow.classList.add('active');
            }

            function setStatus(elementId, message, isError = false) {
                const el = document.getElementById(elementId);
                if(!el) return;
                el.textContent = message;
                el.className = `status-message ${isError ? 'error' : 'success'}`;
                if (['Saving...', 'Uploading...', 'Processing...', 'Adding...', 'Checking...'].includes(message)) return;
                setTimeout(() => { if(el) el.textContent = ''; }, 5000);
            }

            window.addEventListener('load', async () => {
                await loadLeaderboard();
                setTimeout(() => {
                    preloader.style.opacity = '0';
                    setTimeout(() => {
                        preloader.style.display = 'none';
                        showPage('login-page');
                        if (!sessionStorage.getItem('visited')) {
                            if(welcomePopup) welcomePopup.classList.add('active');
                            sessionStorage.setItem('visited', 'true');
                        }
                    }, 500);
                }, 1500);
            });

            function closePopup() { if(welcomePopup) welcomePopup.classList.remove('active'); }
            if(closePopupBtn) closePopupBtn.addEventListener('click', closePopup);
            if(popupCloseIcon) popupCloseIcon.addEventListener('click', closePopup);
            if(welcomePopup) welcomePopup.addEventListener('click', (e) => { if (e.target === welcomePopup) closePopup(); });

            if(document.getElementById('login-form')) {
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('student-id').value.trim();
                    const password = document.getElementById('password').value;
                    const errorEl = document.getElementById('login-error');
                    setStatus('login-error', 'Checking...');

                    if (id === 'instructor' && password === 'inst12023') {
                        sessionStorage.setItem('current_user_role', 'instructor');
                        if(errorEl) errorEl.textContent = '';
                        await loadInstructorPanel();
                        return;
                    }
                    
                    const { data, error } = await db.from('students').select('*').eq('student_id', id).single();
                    if (error || !data || data.password !== password) {
                        setStatus('login-error', 'Invalid Student ID or Password.', true);
                    } else {
                        if(errorEl) errorEl.textContent = '';
                        sessionStorage.setItem('current_user_id', data.student_id);
                        sessionStorage.setItem('current_user_name', data.name);
                        sessionStorage.setItem('current_user_role', 'student');
                        sessionStorage.setItem('current_user_pic', data.profile_pic_url || '');
                        sessionStorage.setItem('current_user_bio', data.bio || '');
                        await loadStudentDashboard(data.student_id);
                    }
                });
            }

            logoutButtons.forEach(btn => btn.addEventListener('click', async () => {
                sessionStorage.clear();
                showPage('login-page');
                const loginForm = document.getElementById('login-form');
                if(loginForm) loginForm.reset();
                await loadLeaderboard();
            }));

            async function loadLeaderboard() {
                 const leaderboardBody = document.getElementById('leaderboard-body');
                const leaderboardHead = document.getElementById('leaderboard-head');
                if(!leaderboardBody || !leaderboardHead) return;
                leaderboardBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Loading...</td></tr>`;
                const { data: latestPaperData, error: paperError } = await db.from('results').select('paper_name').order('created_at', { ascending: false }).limit(1).single();
                if (paperError || !latestPaperData) { leaderboardBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No results found.</td></tr>`; return; }
                const latestPaperName = latestPaperData.paper_name;
                const latestPaperTitle = document.getElementById('latest-paper-title-leaderboard');
                if(latestPaperTitle) latestPaperTitle.textContent = `(${latestPaperName})`;
                leaderboardHead.innerHTML = `<tr><th class="rank">Rank</th><th>Student</th><th>Score</th></tr>`;
                const { data: results, error: resultsError } = await db.from('results').select('student_id, score, students(name, profile_pic_url)').eq('paper_name', latestPaperName).order('score', { ascending: false });
                if (resultsError || !results) { leaderboardBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Could not load results.</td></tr>`; return; }
                leaderboardBody.innerHTML = '';
                results.slice(0, 10).forEach((result, index) => {
                    const rank = index + 1;
                    let rankClass = '', rankIcon = '';
                    if (rank === 1) { rankClass = 'rank-1'; rankIcon = 'ü•á'; } else if (rank === 2) { rankClass = 'rank-2'; rankIcon = 'ü•à'; } else if (rank === 3) { rankClass = 'rank-3'; rankIcon = 'ü•â'; }
                    const studentName = result.students ? result.students.name : 'Unknown Student';
                    const profilePic = result.students ? result.students.profile_pic_url : null;
                    let profilePicElement = profilePic ? `<img src="${profilePic}" alt="${studentName}" class="leaderboard-pic">` : `<div class="leaderboard-pic default-pic"><i class="ph-bold ph-user"></i></div>`;
                    leaderboardBody.innerHTML += `<tr><td class="rank ${rankClass}"><span class="rank-icon">${rankIcon}</span>${rank}</td><td><div class="leaderboard-student">${profilePicElement}<span>${studentName}</span></div></td><td>${result.score}%</td></tr>`;
                });
            }

            async function loadStudentDashboard(studentId) {
                const studentNameEl = document.getElementById('student-name');
                if(studentNameEl) studentNameEl.textContent = sessionStorage.getItem('current_user_name');
                const profilePicUrl = sessionStorage.getItem('current_user_pic');
                const headerProfilePic = document.getElementById('header-profile-pic');
                if(headerProfilePic) headerProfilePic.src = profilePicUrl || defaultProfilePic;
                const { data: allPapersData, error: papersError } = await db.from('results').select('paper_name').order('created_at', { ascending: true });
                if (papersError) { alert("Error fetching paper list"); return; }
                const distinctPaperNames = [...new Set(allPapersData.map(p => p.paper_name))];
                if(distinctPaperNames.length === 0) { showPage('student-dashboard'); return; }
                const latestPaperName = distinctPaperNames[distinctPaperNames.length - 1];
                const latestPaperTitleStudent = document.getElementById('latest-paper-title-student');
                if(latestPaperTitleStudent) latestPaperTitleStudent.textContent = latestPaperName;
                const { data: latestPaperResults, error: latestError } = await db.from('results').select('*').eq('paper_name', latestPaperName);
                if (latestError) { alert("Could not fetch latest results."); return; }
                const studentResult = latestPaperResults.find(r => r.student_id === studentId);
                const studentRankEl = document.getElementById('student-rank');
                const studentScoreEl = document.getElementById('student-score');
                const classAverageScoreEl = document.getElementById('class-average-score');
                const recommendationContainer = document.getElementById('recommendation-container');

                if (!studentResult) {
                    if(studentRankEl) studentRankEl.textContent = 'N/A';
                    if(studentScoreEl) studentScoreEl.textContent = 'N/A';
                    if(classAverageScoreEl) classAverageScoreEl.textContent = 'N/A';
                    if(recommendationContainer) recommendationContainer.style.display = 'none';
                } else {
                    const sortedResults = [...latestPaperResults].sort((a, b) => b.score - a.score);
                    const studentRank = sortedResults.findIndex(r => r.student_id === studentId) + 1;
                    const classAverage = latestPaperResults.reduce((sum, r) => sum + r.score, 0) / latestPaperResults.length;
                    if(studentRankEl) studentRankEl.textContent = `${studentRank}/${latestPaperResults.length}`;
                    if(studentScoreEl) studentScoreEl.textContent = `${studentResult.score}%`;
                    if(classAverageScoreEl) classAverageScoreEl.textContent = `${Math.round(classAverage)}%`;
                    const { data: recData, error: recError } = await db.from('recommendations').select('*').eq('paper_name', latestPaperName).lte('min_score', studentResult.score).gte('max_score', studentResult.score).single();
                    if(!recError && recData) {
                        const recTextEl = document.getElementById('recommendation-text');
                        if(recTextEl) recTextEl.textContent = recData.recommendation_text;
                        const recLink = document.getElementById('recommendation-link');
                        if(recLink) {
                            if(recData.video_link) { recLink.href = recData.video_link; recLink.style.display = 'block'; } else { recLink.style.display = 'none'; }
                        }
                        if(recommendationContainer) recommendationContainer.style.display = 'block';
                    } else { if(recommendationContainer) recommendationContainer.style.display = 'none'; }
                }
                const historyBody = document.getElementById('history-table-body');
                if(historyBody) historyBody.innerHTML = '';
                const chartLabels = [], studentScores = [], averageScores = [];
                for (const paperName of distinctPaperNames) {
                    const { data: paperResults } = await db.from('results').select('*').eq('paper_name', paperName);
                    if (!paperResults) continue;
                    const pSorted = [...paperResults].sort((a, b) => b.score - a.score);
                    const pResult = paperResults.find(r => r.student_id === studentId);
                    if(!pResult) continue;
                    const pRank = pSorted.findIndex(r => r.student_id === studentId) + 1;
                    const pAvg = paperResults.reduce((sum, r) => sum + r.score, 0) / paperResults.length;
                    if(historyBody) historyBody.innerHTML += `<tr><td>${paperName}</td><td>${pResult.score}%</td><td>${pRank}/${paperResults.length}</td><td>${Math.round(pAvg)}%</td></tr>`;
                    chartLabels.push(paperName); studentScores.push(pResult.score); averageScores.push(pAvg);
                }
                createProgressChart(chartLabels, studentScores, averageScores);
                const { data: annData, error: annError } = await db.from('announcements').select('*').order('created_at', { ascending: false }).limit(1).single();
                const announcementDisplay = document.getElementById('announcement-display');
                if(announcementDisplay && !annError && annData){ announcementDisplay.innerHTML = `<h4>${annData.title}</h4><p>${annData.content}</p><small>Posted by ${annData.instructor_name}</small>`; }
                showPage('student-dashboard');
            }
            
            function createProgressChart(labels, studentData, averageData) {
                const ctx = document.getElementById('progress-chart')?.getContext('2d');
                if(!ctx) return;
                if (progressChartInstance) progressChartInstance.destroy();
                progressChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Your Score', data: studentData, borderColor: 'rgba(83, 114, 240, 1)', backgroundColor: 'rgba(83, 114, 240, 0.2)', fill: true, tension: 0.3 }, { label: 'Class Average', data: averageData, borderColor: 'rgba(255, 255, 255, 0.5)', borderDash: [5, 5], fill: false, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#adb5bd' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#adb5bd' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, plugins: { legend: { labels: { color: '#e9ecef' } } } } });
            }

            async function loadInstructorPanel() {
                const { data: allPapersData } = await db.from('results').select('paper_name').order('created_at', { ascending: true });
                if (allPapersData) {
                    const paperDropdown = document.getElementById('rec-paper-name');
                    if(paperDropdown) {
                        paperDropdown.innerHTML = '<option value="">Select a Paper</option>';
                        [...new Set(allPapersData.map(p => p.paper_name))].forEach(name => { paperDropdown.innerHTML += `<option value="${name}">${name}</option>`; });
                    }
                }
                await loadDistributionChart(); await loadStudentList();
                showPage('instructor-panel');
            }
            
            async function loadDistributionChart() {
                const { data: latestPaperData } = await db.from('results').select('paper_name').order('created_at', { ascending: false }).limit(1).single();
                if (!latestPaperData) return;
                const { data: results } = await db.from('results').select('score').eq('paper_name', latestPaperData.paper_name);
                if (!results) return;
                const bins = { '0-34': 0, '35-54': 0, '55-64': 0, '65-74': 0, '75-100': 0 };
                results.forEach(r => { if (r.score <= 34) bins['0-34']++; else if (r.score <= 54) bins['35-54']++; else if (r.score <= 64) bins['55-64']++; else if (r.score <= 74) bins['65-74']++; else bins['75-100']++; });
                const ctx = document.getElementById('distribution-chart')?.getContext('2d');
                if(!ctx) return;
                if (distributionChartInstance) distributionChartInstance.destroy();
                distributionChartInstance = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(bins), datasets: [{ label: 'Number of Students', data: Object.values(bins), backgroundColor: 'rgba(83, 114, 240, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#adb5bd', stepSize: 1 } }, x: { ticks: { color: '#adb5bd' } } }, plugins: { legend: { display: false } } } });
            }

            document.getElementById('upload-form')?.addEventListener('submit', (e) => { e.preventDefault(); const fileInput = document.getElementById('results-file'); const file = fileInput.files[0]; const paperName = document.getElementById('paper-name').value.trim(); if (!file || !paperName) return; const reader = new FileReader(); reader.onload = async (event) => { const lines = event.target.result.split('\n').filter(l => l.trim() !== ''); const resultsToUpload = lines.map(line => { const [id, score] = line.split(','); return { paper_name: paperName, student_id: id.trim(), score: parseInt(score.trim()) }; }); setStatus('upload-status', `Uploading ${resultsToUpload.length} records...`); const { error } = await db.from('results').insert(resultsToUpload); if (error) setStatus('upload-status', `Error: ${error.message}`, true); else { setStatus('upload-status', 'Upload successful!'); document.getElementById('upload-form').reset(); await loadInstructorPanel(); } }; reader.readAsText(file); });
            document.getElementById('recommendation-form')?.addEventListener('submit', async (e) => { e.preventDefault(); const data = { paper_name: document.getElementById('rec-paper-name').value, min_score: parseInt(document.getElementById('min-score').value), max_score: parseInt(document.getElementById('max-score').value), recommendation_text: document.getElementById('rec-text').value.trim(), video_link: document.getElementById('rec-link').value.trim() || null }; setStatus('rec-status', 'Adding...'); const { error } = await db.from('recommendations').insert(data); if (error) setStatus('rec-status', `Error: ${error.message}`, true); else { setStatus('rec-status', 'Recommendation added!'); document.getElementById('recommendation-form').reset(); } });
            document.getElementById('announcement-form')?.addEventListener('submit', async (e) => { e.preventDefault(); const data = { title: document.getElementById('ann-title').value.trim(), content: document.getElementById('ann-content').value.trim(), instructor_name: 'Instructor' }; setStatus('ann-status', 'Posting...'); const { error } = await db.from('announcements').insert(data); if (error) setStatus('ann-status', `Error: ${error.message}`, true); else { setStatus('ann-status', 'Announcement posted!'); document.getElementById('announcement-form').reset(); } });
            
            document.getElementById('my-profile-btn')?.addEventListener('click', () => {
                processedImageFile = null;
                document.getElementById('profile-bio').value = sessionStorage.getItem('current_user_bio') || '';
                document.getElementById('profile-pic-preview').src = sessionStorage.getItem('current_user_pic') || defaultProfilePic.replace('100x100', '150x150');
                document.getElementById('profile-pic-file').value = '';
                setStatus('profile-status', '');
                showPage('profile-page');
            });
            document.getElementById('back-to-dash-btn')?.addEventListener('click', () => showPage('student-dashboard'));
            document.getElementById('profile-pic-file')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const preview = document.getElementById('profile-pic-preview');
                const saveButton = document.getElementById('save-profile-btn');
                if (!file) { processedImageFile = null; preview.src = sessionStorage.getItem('current_user_pic') || defaultProfilePic.replace('100x100', '150x150'); return; }
                setStatus('profile-status', `Processing: ${file.name}...`);
                saveButton.disabled = true;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const MAX_DIMENSION = 512;
                        let sourceX, sourceY, sourceWidth, sourceHeight;
                        if (img.width > img.height) { sourceHeight = img.height; sourceWidth = img.height; sourceX = (img.width - img.height) / 2; sourceY = 0; } else { sourceWidth = img.width; sourceHeight = img.width; sourceY = (img.height - img.width) / 2; sourceX = 0; }
                        canvas.width = MAX_DIMENSION; canvas.height = MAX_DIMENSION;
                        ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, MAX_DIMENSION, MAX_DIMENSION);
                        preview.src = canvas.toDataURL('image/jpeg');
                        canvas.toBlob((blob) => {
                            processedImageFile = blob;
                            setStatus('profile-status', `Ready: ${file.name} (~${(blob.size / 1024).toFixed(1)} KB)`);
                            saveButton.disabled = false;
                        }, 'image/jpeg', 0.7);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('profile-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const studentId = sessionStorage.getItem('current_user_id');
                const fileToUpload = processedImageFile;
                const saveButton = document.getElementById('save-profile-btn');
                let newProfilePicUrl = sessionStorage.getItem('current_user_pic') || null;
                saveButton.disabled = true; setStatus('profile-status', 'Saving...');
                if (fileToUpload) {
                    setStatus('profile-status', 'Uploading image...');
                    const filePath = `${studentId}/${Date.now()}_profile.jpeg`;
                    const { error: uploadError } = await db.storage.from('profile-pictures').upload(filePath, fileToUpload, { cacheControl: '3600', upsert: false, });
                    if (uploadError) { setStatus('profile-status', `Error uploading image: ${uploadError.message}`, true); saveButton.disabled = false; return; }
                    const { data: urlData } = db.storage.from('profile-pictures').getPublicUrl(filePath);
                    newProfilePicUrl = urlData.publicUrl;
                }
                setStatus('profile-status', 'Updating profile...');
                const updates = { profile_pic_url: newProfilePicUrl, bio: document.getElementById('profile-bio').value.trim() || null };
                const { error: updateError } = await db.from('students').update(updates).eq('student_id', studentId);
                if (updateError) { setStatus('profile-status', `Error updating profile: ${updateError.message}`, true); } else {
                    setStatus('profile-status', 'Profile updated successfully!');
                    sessionStorage.setItem('current_user_pic', updates.profile_pic_url || '');
                    sessionStorage.setItem('current_user_bio', updates.bio || '');
                    document.getElementById('header-profile-pic').src = updates.profile_pic_url || defaultProfilePic;
                    document.getElementById('profile-pic-file').value = '';
                    processedImageFile = null;
                }
                saveButton.disabled = false;
            });

            async function loadStudentList() {
                const listBody = document.getElementById('student-list-body');
                if(!listBody) return;
                listBody.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';
                const { data, error } = await db.from('students').select('student_id, name').order('created_at', { ascending: false });
                if (error) { listBody.innerHTML = '<tr><td colspan="2" style="color:var(--danger)">Error loading students.</td></tr>'; return; }
                if (data.length === 0) { listBody.innerHTML = '<tr><td colspan="2">No students found.</td></tr>'; return; }
                listBody.innerHTML = data.map(student => `<tr><td>${student.student_id}</td><td>${student.name}</td></tr>`).join('');
            }
            document.getElementById('add-student-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const studentId = document.getElementById('new-student-id').value.trim();
                const studentName = document.getElementById('new-student-name').value.trim();
                const studentPassword = document.getElementById('new-student-password').value.trim();
                if (!studentId || !studentName || !studentPassword) { setStatus('add-student-status', 'All fields are required.', true); return; }
                setStatus('add-student-status', 'Adding student...');
                const { error } = await db.from('students').insert({ student_id: studentId, name: studentName, password: studentPassword });
                if (error) { if (error.message.includes('unique constraint')) { setStatus('add-student-status', 'This Student ID already exists.', true); } else { setStatus('add-student-status', `Error: ${error.message}`, true); } } else { setStatus('add-student-status', 'Student added successfully!'); document.getElementById('add-student-form').reset(); await loadStudentList(); }
            });
        });
    </script>
</body>
</html>


